<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript" src="./data/scenarios.js"></script>
    <script type="text/javascript" src="./data/monster_stats.js"></script>
    <script type="text/javascript" src="./data/cards.js"></script>
    <script type="text/javascript" src="./data/macros.js"></script>
    <meta charset="UTF-8">
    <title>Gloomhaven DM</title>
</head>
<body style="background-color: black; font-family: 'Poppins', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-weight:600; color:white;">
    <div style="width:300px;">
        <div style="display:flex; width: 100%;">
            <div>Scenario</div>
            <input style="margin-left:20px; flex-grow: 1;" type="number" id="scenarioId" onkeydown="getScenario()">
        </div>
        <div style="display:flex;">
            <div>Level</div>
            <input style="margin-left:20px; flex-grow: 1;" type="number" id="levelId" value="0" onkeydown="getScenario()">
        </div>
    </div>
    <div>
        <button onclick="draw()">Draw</button>
    </div>

    <div style="display: flex; flex-direction: column;" id="monsters">

    </div>
</body>
<script>
    let monsters = [];

    function getScenario() {
        if(event.key === 'Enter') {
            let scenario = document.getElementById("scenarioId").value - 1;
            document.getElementById("scenarioId").value = "";
            let scenarioLevel = document.getElementById("levelId").value;

            for(let i = 0; i < SCENARIO_DEFINITIONS[scenario].decks.length; i++) {
                let monster = {};

                monster.name = SCENARIO_DEFINITIONS[scenario].decks[i].name;
                monster.stats = MONSTER_STATS.monsters[SCENARIO_DEFINITIONS[scenario].decks[i].name].level[scenarioLevel];

                monster.div = document.createElement("DIV");
                monster.div.style.cssText = "display:flex; justify-content:space-between;";

                monster.image = document.createElement("IMG");
                monster.image.style.cssText = "width:fit-content; height:fit-content;";
                monster.image.src = "./images/monster-images/" + SCENARIO_DEFINITIONS[scenario].decks[i].image;

                let name = document.createElement("DIV");
                name.innerText = monster.name;
                name.style.cssText = "writing-mode:vertical-rl; transform:rotate(180deg); margin:10px; cursor:pointer;";
                monster.div.appendChild(name);
                name.onclick = function() { addNewMonster(monster, false); };
                if(monster.stats.elite) {
                    let elite = document.createElement("DIV");
                    elite.innerText = "elite";
                    elite.style.cssText = "writing-mode:vertical-rl; transform:rotate(180deg); margin:10px; cursor:pointer;";
                    monster.div.appendChild(elite);
                    elite.onclick = function() { addNewMonster(monster, true); };
                }

                monster.list = document.createElement("DIV");
                monster.list.style.cssText = "flex-grow:1; display:flex;";
                monster.div.appendChild(monster.list);

                document.getElementById("monsters").appendChild(monster.div);

                monster.deck = [];
                for(let k = 0; k < DECK_DEFINITONS.length; k++) {
                    if(DECK_DEFINITONS[k].class == SCENARIO_DEFINITIONS[scenario].decks[i].deck_name)
                        monster.deck = DECK_DEFINITONS[k].cards;
                }
                shuffle(monster.deck);
                monsters.push(monster);
                console.log(monster);
            }
        }
    }

    function addNewMonster(monster, isElite) {
        let newMonster = document.createElement("DIV");
        newMonster.style.cssText = "position:relative;";

        let newMonsterImage = document.createElement("IMG");
        if(isElite) {
            newMonsterImage.style.cssText = "width:fit-content; height:fit-content; border:solid yellow; border-radius:2px;";
        } else {
            newMonsterImage.style.cssText = "width:fit-content; height:fit-content;";
        }
        newMonsterImage.src = monster.image.src;
        newMonster.appendChild(newMonsterImage);

        if(isElite) {
            newMonster.stats = monster.stats.elite;
        } else {
            newMonster.stats = monster.stats.normal;
        }
        if (newMonster.stats == null) {
            newMonster.stats = monster.stats;
        }

        let statsBlock = document.createElement("DIV");
        statsBlock.style.cssText = "position:absolute; top:0; padding:5px;";

        let newMonsterHealth = document.createElement("DIV");
        newMonsterHealth.style.cssText = "display:flex;";
        let healthIcon = document.createElement("IMG");
        healthIcon.style.cssText = "height:20px; width:20px;";
        healthIcon.src = "./icons/heal.svg";
        newMonsterHealth.appendChild(healthIcon);
        let healthValue = document.createElement("DIV");
        healthValue.innerText = newMonster.stats.health;
        newMonsterHealth.appendChild(healthValue);
        statsBlock.appendChild(newMonsterHealth);

        let newMonsterMove = document.createElement("DIV");
        newMonsterMove.style.cssText = "display:flex;";
        let moveIcon = document.createElement("IMG");
        moveIcon.style.cssText = "height:20px; width:20px;";
        moveIcon.src = "./icons/move.svg";
        newMonsterMove.appendChild(moveIcon);
        let moveValue = document.createElement("DIV");
        moveValue.innerText = newMonster.stats.attack;
        newMonsterMove.appendChild(moveValue);
        statsBlock.appendChild(newMonsterMove);


        let newMonsterAttack = document.createElement("DIV");
        newMonsterAttack.style.cssText = "display:flex;";
        let attackIcon = document.createElement("IMG");
        attackIcon.style.cssText = "height:20px; width:20px;";
        attackIcon.src = "./icons/attack.svg";
        newMonsterAttack.appendChild(attackIcon);
        let attackValue = document.createElement("DIV");
        attackValue.innerText = newMonster.stats.attack;
        newMonsterAttack.appendChild(attackValue);
        statsBlock.appendChild(newMonsterAttack);

        let newMonsterRange = document.createElement("DIV");
        newMonsterRange.style.cssText = "display:flex;";
        let rangeIcon = document.createElement("IMG");
        rangeIcon.style.cssText = "height:20px; width:20px;";
        rangeIcon.src = "./icons/range.svg";
        newMonsterRange.appendChild(rangeIcon);
        let rangeValue = document.createElement("DIV");
        rangeValue.innerText = newMonster.stats.attack;
        newMonsterRange.appendChild(rangeValue);
        statsBlock.appendChild(newMonsterRange);

        let newMonsterAttributes = document.createElement("DIV");
        if(newMonster.stats.attributes != null && newMonster.stats.attributes.length > 0) {
            newMonsterAttributes.innerText = newMonster.stats.attributes;
        }
        statsBlock.appendChild(newMonsterAttributes);

        let newMonsterImmunities = document.createElement("DIV");
        if(newMonster.stats.immunities != null && newMonster.stats.immunities.length > 0) {
            newMonsterImmunities.innerText = newMonster.stats.immunities;
        }
        statsBlock.appendChild(newMonsterImmunities);

        newMonster.appendChild(statsBlock);

        monster.list.appendChild(newMonster);
        console.log(monster);
    }

    function draw() {
        let oldCards = document.getElementsByClassName("card");
        while(oldCards[0]) {
            oldCards[0].parentNode.removeChild(oldCards[0]);
        }

        for(monster in monsters) {
            let card = monsters[monster].deck[Math.floor(Math.random() * monsters[monster].deck.length)];
            let cardElement = document.createElement("DIV");
            cardElement.className = "card";
            console.log(card.toString());
            cardElement.innerHTML = parseString(card.toString());
            monsters[monster].div.appendChild(cardElement);
            createCard(card);
        }
    }

    function shuffle(array) {
        let currentIndex = array.length;
        let temporaryValue, randomIndex;
        while (0 !== currentIndex) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
        }
        return array;
    }

    function createCard(data) {
        let card = document.createElement("DIV");
        card.style.cssText = "position:relative;";
        let cardData = {};
        cardData.shuffle = data[0];
        cardData.initiative = data[1];
        cardData.cardText = [];
        cardData.cardText = parseString(data);
        console.log(cardData);
    }

    function expand_macro(macro) {
        let key = macro.toLowerCase();
        if (key in MACROS) {
            return MACROS[key];
        } else {
            return macro;
        }
    }

    function parseString(string) {
        let result = "";
        if(string != null) {
            if(Array.isArray(string)) {
                console.log(string);
                for (let i = 0; i < string.length; i++) {
                    if(string[i] != null && string[i].replace != null) {
                        result += string[i].replace(/%[^%]*%/gi, expand_macro);
                    }
                }
            } else {
                result = string.replace(/%[^%]*%/gi, expand_macro);
            }
        }
        result = result.replace(/\*/g, "");
        return result;
    }
</script>
</html>