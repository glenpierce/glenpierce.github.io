<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript" src="./data/scenarios.js"></script>
    <script type="text/javascript" src="./data/monster_stats.js"></script>
    <script type="text/javascript" src="./data/monster-ability-cards.js"></script>
    <meta charset="UTF-8">
    <title>Gloomhaven DM</title>
</head>
<body>
    <div style="display:flex;">
        <div>Scenario</div>
        <input type="number" id="scenarioId" onkeydown="getScenario()">
    </div>
    <div style="display:flex;">
        <div>Level</div>
        <input type="number" id="levelId" value="0" onkeydown="getScenario()">
    </div>
    <div>
        <button onclick="draw()">Draw</button>
    </div>

    <div style="display: flex; flex-direction: column;" id="monsters">

    </div>
</body>
<script>
    var monsters = [];

    function getScenario() {
        if(event.key === 'Enter') {
            scenario = document.getElementById("scenarioId").value - 1;
            document.getElementById("scenarioId").value = "";
            scenarioLevel = document.getElementById("levelId").value;

            for(i = 0; i < SCENARIO_DEFINITIONS[scenario].decks.length; i++) {
                let monster = {};

                monster.name = SCENARIO_DEFINITIONS[scenario].decks[i].name;
                monster.stats = MONSTER_STATS.monsters[SCENARIO_DEFINITIONS[scenario].decks[i].name].level[scenarioLevel];

                monster.div = document.createElement("DIV");
                monster.div.style = "display:flex; justify-content:space-between;";

                monster.image = document.createElement("IMG");
                monster.image.style = "width:fit-content; height:fit-content;";
                monster.image.src = "./images/monster-images/" + SCENARIO_DEFINITIONS[scenario].decks[i].image;
                monster.div.appendChild(monster.image);
                monster.image.onclick = function() { addNewMonster(monster); };

                monster.list = document.createElement("DIV");
                monster.list.style = "flex-grow:1; display:flex;";
                monster.div.appendChild(monster.list);

                document.getElementById("monsters").appendChild(monster.div);

                monster.deck = [];
                for(k = 0; k < MONSTER_ABILITY_CARDS.length; k++) {
                    if(MONSTER_ABILITY_CARDS[k].deck == SCENARIO_DEFINITIONS[scenario].decks[i].deck_name)
                        monster.deck.push(MONSTER_ABILITY_CARDS[k]);
                }
                monster.deck.pop();
                shuffle(monster.deck);
                monsters.push(monster);
            }
        }
    }

    function addNewMonster(monster) {
        let newMonster = document.createElement("DIV");

        let newMonsterImage = document.createElement("IMG");
        newMonsterImage.style = "width:fit-content; height:fit-content;";
        newMonsterImage.src = monster.image.src;
        newMonster.appendChild(newMonsterImage);

        if(newMonster.elite) {
            newMonster.stats = monster.stats.elite;
        } else {
            newMonster.stats = monster.stats.normal;
        }
        if (newMonster.stats == null) {
            newMonster.stats = monster.stats;
        }

        let newMonsterAttack = document.createElement("DIV");
        newMonsterAttack.style = "position:relative;";
        newMonsterAttack.innerText = newMonster.stats.attack;
        newMonster.appendChild(newMonsterAttack);

        monster.list.appendChild(newMonster);
        console.log(monster);
    }

    function draw() {
        let oldCards = document.getElementsByClassName("card");
        while(oldCards[0]) {
            oldCards[0].parentNode.removeChild(oldCards[0]);
        }

        for(monster in monsters) {
            let card = monsters[monster].deck[Math.floor(Math.random() * monsters[monster].deck.length)];
            card.imageElement = document.createElement("IMG");
            card.imageElement.className = "card";
            card.imageElement.src = "./images/" + card.image;
            monsters[monster].div.appendChild(card.imageElement);
        }
    }

    function shuffle(array) {
        var currentIndex = array.length;
        var temporaryValue, randomIndex;
        while (0 !== currentIndex) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
        }
        return array;
    }
</script>
</html>